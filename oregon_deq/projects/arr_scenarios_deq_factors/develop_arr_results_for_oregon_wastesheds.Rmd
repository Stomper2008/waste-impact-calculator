---
title: "Creating Alternative Recovery Rate results for Oregon wastesheds"
output: html_notebook
---

by Martin Brown, Martin.Brown@state.or.us

The goal of this R markdown notebook is to generate the results used in ARR analyses, specifically for Oregon wastesheds.

Basically I need to take the existing solid waste data file and impact factors, and calculate weight and impact factors for each of them.  At first I will just do this for the current "baseline" data set, but then I will create variant data sets based on the ARR scenarios.

I will document this more later.

Important assumptions:

* the baseline mass profile contains the entire solid waste stream
* the impact factor file contains not just impact factors for all the dispositions in the mass profile, but all the dispositions we wish to consider.
* material and disposition names are perfectly matched between the mass profile and impact factor files
* the "umbDisp" (umbrella disposition) field is filled in and meaningful for each line of the entry.

Load in some packages I might use
```{r}
library(tidyverse)
library(scales)
library(knitr)
library(rmarkdown)
library(svglite)
library(ggthemes)
```
Run some code to set a graphic style.

```{r}
source("../../resources/theme_539.R")
```


Load in the baseline masses and the impact factors.
```{r}
baseline_mass_profile <-
  readRDS("intermediate_output/baseline_mass_profile.RData")
  
impact_factors <-
  readRDS("intermediate_output/impact_factors.RData")
```

I need to generate the end-of-life mass table in the particular form necessary for the weight chart.

```{r}
masses_eol <- baseline_mass_profile

masses_eol_by_umbDisp <-
  summarise(
    group_by(masses_eol, year, wasteshed, material, umbDisp),
    tons=sum(tons)
  ) %>%
  ungroup() %>%
  mutate(
    datatype="weight",
    recovered_tons = ifelse(umbDisp=="recovery",tons,0)
  )

masses_eol_with_rr <-
  summarise(
    group_by(masses_eol_by_umbDisp, year, wasteshed, material),
    tons = sum(tons),
    recovered_tons=sum(recovered_tons)
  ) %>%
  ungroup() %>%
  group_by(year, wasteshed) %>%
  mutate(
    wb_recovery_rate=recovered_tons/tons,
    pctOfTotal = tons/sum(tons)
    ) %>% 
  ungroup()
```

Now I've got to get impact numbers.  This will be considerably longer as there are approximately half a dozen impact categories I am using.

The following impact calculation will (eventually) depend on end-of-life-transport mileages customized to each wasteshed.  For now I will just use the defaults.

```{r}
# before I can calculate life cycle impacts I need to add production tons.
masses_prod <-
  masses_eol_with_rr %>%
  select(year, wasteshed, material, tons) %>%
  mutate(disposition="production", umbDisp="production")
masses_lc <-
  bind_rows(
    masses_eol,
    masses_prod
  ) %>%
  arrange(year, wasteshed, material,  disposition)

masses_with_impacts_in_detail <-
  left_join(
    masses_lc,
    impact_factors,
    by=c("material", "disposition")
  ) %>%
  mutate(
    miles=impliedMiles,  #sets end-of-life-mileage to default values
    # nb "miles" should only be changed when LCstage="endOfLifeTransport"
    # otherwise the following impact calculation will be wrong
    impact=tons*impactFactor*miles/impliedMiles #calculates impacts
  ) %>%
  arrange(impactCategory, year, wasteshed, material, LCstage, disposition)

impacts_by_wasteshed_and_material <-
  summarise(
    group_by(
      masses_with_impacts_in_detail,
      impactCategory,
      impactUnits,
      year, wasteshed, material
    ),
    impact=sum(impact)
  ) %>%
  ungroup() %>%
  group_by(impactCategory, impactUnits, year, wasteshed) %>%
  mutate(pctOfTotal=impact/sum(impact)) %>%
  ungroup()
```


At this point I am almost ready to create the first two "potential of recovery" type charts, which are the wastestream waste chart, and the percent weight vs. percent impact chart.

So i need to make a file that has these values

impactCategory
impactUnits
year
wasteshed
material
datatype (weight or impact)
stat (pctTons, or pctOfImpact)

```{r}
junk1 <-
  masses_eol_with_rr %>%
  select(year, wasteshed, material, tons, pctOfTotal) %>%
  mutate(
    impactCategory="Weight", 
    impactUnits="short tons",
    datatype="weight"
    ) %>%
  rename(magnitude=tons)
junk2 <-
  impacts_by_wasteshed_and_material %>%
  mutate(datatype="impact") %>%
  rename(magnitude=impact)

material_sort_order <-
  summarise(
    group_by(masses_eol_with_rr, material),
    tons=sum(tons)
  ) %>%
  ungroup() %>%
  arrange(tons) %>%
  pull(material)

weight_vs_impact_chart_data <-
  bind_rows(junk2, junk1) %>%
  mutate(
    datatype=factor(datatype, levels=c("weight","impact")),
    material=factor(material, levels=material_sort_order)
  )

saveRDS(
  weight_vs_impact_chart_data,
  "intermediate_output/weight_vs_impact_chart_data.RData"
)
write.csv(
  weight_vs_impact_chart_data,
  "intermediate_output/weight_vs_impact_chart_data.csv",
  row.names = F
)

```

So weight_vs_impact_chart_data should have what I need.

let's make the chart.

```{r fig.height=4.5, fig.width=6}
junk3 <-
  weight_vs_impact_chart_data %>%
  filter(
    (impactCategory=="Weight" | impactCategory=="Energy demand")
    & wasteshed=="Benton"
  ) 
ggplot()+
  theme_539()+
  geom_bar(
    data=junk3,
    aes(x=material, y=pctOfTotal, color=datatype, fill=datatype),
    alpha=0.5,
    stat="identity",
    position="stack"
  )+
  facet_grid(.~datatype)+
  coord_flip()+
  theme(legend.position="none")
  
```

let's clean up some of this workspace.

```{r}
rm(junk1, junk2, junk3)
```

## Interpreting the alternative recovery rate law

Now it's time to do the thing I've been dreading... figure out how to interpret the "Alternative Recovery Rate" law in terms of data processing.

To sum up, oregon law requires DEQ to calculate "recovery rates" based on the impacts associated with different conceptual ways of dealing with solid waste.  In the Waste Impact Calculator model, this is equivalent to taking observed solid waste and applying it to different end of life dispositions.  For each conceptual management scenario, a mass profile is created.  Each mass profile can be converted into a life cycle impact.  Comparing the impacts associated with the scenarios generates the alternative recovery rate.

To get more detailed than that, let's look at the [text of the Alternative Recovery Rate law](https://www.oregonlaws.org/ors/459A.012).

>ORS 459A.012 - Alternative recovery rate calculation methods

>(1)(a) The Environmental Quality Commission shall develop and adopt by rule a method for calculating recovery rates based on the rate of energy savings achieved by recovering materials from the general solid waste stream. The calculation method must account for:

>(A) The energy savings achieved from material recovery, as opposed to material disposal;

>(B) Recovery of energy from waste, including methane recovery at landfills; and

>(C) Energy saving practices implemented as part of local solid waste reduction, reuse and recycling programs or solid waste management programs, including but not limited to:

>(i) Fuel, efficiency and other improvements involving waste collection vehicles;

>(ii) Energy efficiency improvements at recycling and solid waste facilities; and

>(iii) Production of energy from renewable sources at solid waste facilities through means other than recovery of energy from waste, such as the use of solar energy to produce electricity.

>(b) A recovery rate of 100 percent under the calculation method is equivalent to the energy savings achieved if all materials in the general solid waste stream are directed to their optimal final destinations for purposes of the energy savings that can be achieved through the recovery of each type of material.

>(2) Using the calculation method developed under subsection (1) of this section, the commission shall adopt by rule recovery goals consistent with the goals under ORS 459A.010 (Policy) (1) and (2).

>(3)(a) The commission may develop and adopt by rule other methods for calculating recovery rates from the general solid waste stream that are based on achieving outcomes that result from waste recovery and management, and may include but are not limited to the following:

>(A) Reductions in greenhouse gas emissions.

>(B) Reductions in the emissions of toxic or potentially toxic chemicals.

>(C) Water conservation.

>(b) The commission may adopt by rule other outcome-based recovery goals consistent with the goals under ORS 459A.010 (Policy) (1) and (2) using outcome-based calculation methods developed under this subsection. [2015 c.534 ยง9]

That's the whole text.  Now let's parse it a bit.

>(1)(a) ...recovery rates based on the rate of energy savings achieved by recovering materials from the general solid waste stream. 

So it is about recovering materials from the general solid waste stream.   That's the data DEQ usually deals with, so no big change in focus there.  Important point: existing law already defines "recovery."  So we are not changing the definition of "recovery."

> The calculation method must account for:

>(A) The energy savings achieved from material recovery, as opposed to material disposal;

This part sets up the first contrast... the SAVINGS achieved via recovery IN CONTRAST to disposal.  Disposal is also defined in law.  So, savings= energy associated with disposal MINUS energy associated with recovery.

Savings are always a DIFFERENCE.  In this case the difference is between the energy impact of disposal and the energy impact of recovery.

This is the key thing.  SAVINGS ARE A DIFFERENCE.

>(B) Recovery of energy from waste, including methane recovery at landfills; and

This part insists that energy recovery, including methane recovery at landfills, be part of calculations.  This is already the case.  Peter Canepa's landfilling and incineration impact factors include energy recovered via combustion.  I should confirm this.

I do not take this line to mean that the state's definition of recovery is changing.  This section of law does not overrule the rest of the law, it merely provides an alternative statistic for progress.

>(C) Energy saving practices implemented as part of local solid waste reduction, reuse and recycling programs or solid waste management programs, including but not limited to:

>(i) Fuel, efficiency and other improvements involving waste collection vehicles;

>(ii) Energy efficiency improvements at recycling and solid waste facilities; and

>(iii) Production of energy from renewable sources at solid waste facilities through means other than recovery of energy from waste, such as the use of solar energy to produce electricity.

These clauses are problematic from a practical perspective.  The law is about differences in energy use between disposal and recovery.  If there are energy efficiency improvements within the infrastructure, they could affect disposal energy use, recovery energy use, or both.  So it's not clear where such improvements would be applied, or if they would influence the ultimate calculation of DIFFERENCE between disposal and recovery.

In addition, figuring out the energy impact characteristics of specific technological changes is a lot of work that requires a skilled analyst. Investigating every notion of this kind could easily overwhelm DEQ's office.  This seems like a bad use of ratepayer money when it is very likely such technological changes will have only small influence over the ultimate energy impact numbers.

Accordingly, I suggest that any corrections of this kind be supplied by the wastesheds themselves.  I will provide them with a format to use.  And they must submit a file in that format, with documentation of evidence behind their numbers.

>(b) A recovery rate of 100 percent under the calculation method is equivalent to the energy savings achieved if all materials in the general solid waste stream are directed to their optimal final destinations for purposes of the energy savings that can be achieved through the recovery of each type of material.

This is the other key section.  The energy use associated with recovery is to be calculated for the OPTIMAL scenario.  Where each individual material goes to its lowest-impact destination.

This is where the methodological stuff ends.  I am left with this interpretation...

* savings is a difference
* the maximum possible savings is energy use linked to DISPOSING EVERYTHING minus energy use linked to RECOVERING EVERYTHING OPTIMALLY. This difference defines the 100% recovery rate.
* the current savings is energy use linked to DISPOSING EVERYTHING minus the energy use linked to THE CURRENT MIX OF DISPOSAL AND RECOVERY.

Or, let's shorten the lingo and give these scenarios names.

* current savings = DISPOSE_ALL - ACTUAL
* max possible savings = DISPOSE_ALL - OPTIMAL
* alternative recovery rate = CURRENT_SAVINGS/MAX_POSSIBLE_SAVINGS

>(2) Using the calculation method developed under subsection (1) of this section, the commission shall adopt by rule recovery goals consistent with the goals under ORS 459A.010 (Policy) (1) and (2).

This section just says there will be written goals based on these numbers.

>(3)(a) The commission may develop and adopt by rule other methods for calculating recovery rates from the general solid waste stream that are based on achieving outcomes that result from waste recovery and management, and may include but are not limited to the following:

>(A) Reductions in greenhouse gas emissions.

>(B) Reductions in the emissions of toxic or potentially toxic chemicals.

>(C) Water conservation.

>(b) The commission may adopt by rule other outcome-based recovery goals consistent with the goals under ORS 459A.010 (Policy) (1) and (2) using outcome-based calculation methods developed under this subsection. [2015 c.534 ยง9]

These sections just say that the same logic can be applied to other impact categories.  

So whatever computing logic I come up with, it has to work for all the impact categories, not just energy use.  That's no big deal.

### The way to do this.

The ACTUAL scenario is easy.  Just take the current materials, dispositions, and end-of-life mileages and calculate the impacts for them.  All I really need to do here is to add a "scenario" label to the existing mass profile.

The DISPOSE_ALL scenario is a little trickier.  All of the currently disposed stuff will go to the same dispositions.  But all of the currently recovered stuff will go to disposal dispositions.  Simplest would just be to landfill it I suppose.  But more accurate might be to use the same mix of disposal dispositions (landfilling vs. incineration) as are currently used.  A bit of a pain but doable.

The OPTIMAL scenario is the most labor.  So, for each wasteshed and material, there are a number of plausible recovery dispositions.  The aggregate impact factors for each (a combination of end-of-life impact factor and end-of-life-transport factor for the custom distance) must be calculated and then sorted.  The disposition with the lowest impact factor is the one that will then be applied to ALL of that wasteshed's material.  

These dispositions may actually be different for different impact categories... meaning there are actually numerous different versions of the OPTIMAL scenario, depending on which impact category you are interested in.

To deal with this hassle, you might choose one impact category.  Or you might average them.  Or I guess you could add an additional indexing variable to keep them all separate... but that would make display in the shiny app weird.  You would display only the optimal mass profile associated with the currently selected impact category.

I guess this indexing variable would have the same range of values as "impactCategory".

Ok, I have a direction.  Next step is just to do it.  Just do it systematically.  Build in checks.

```{r}
# labelling the actual scenario
junk_actual <-
  masses_lc %>% mutate(scenario="actual", optVariant="actual")

# working up the dispose all scenario
# first, stuff that will stay the same
junk_dispose_static <-
  masses_lc %>% 
  filter(umbDisp=="production" | umbDisp=="disposal")
# next, stuff that will change
junk_dispose_alter1 <-
  masses_lc %>% filter(umbDisp=="recovery")
# summarizing the alterable tons
junk_dispose_alter2 <-
  summarise(
    group_by(
      junk_dispose_alter1,
      year, wasteshed, material
    ),
    tons=sum(tons)
  )
# now multiplying that across the observed disposal fractions for that wasteshed.
# the disposal fraction data
disposal_disposition_proportions_by_wasteshed <-
  readRDS(
    "intermediate_output/disposal_disposition_proportions_by_wasteshed.RData"
  )
junk_dispose_alter3 <-
  left_join(
    junk_dispose_alter2,
    disposal_disposition_proportions_by_wasteshed,
    by = c("year", "wasteshed")
  ) %>%
  rename(total_tons=tons) %>%
  mutate(
    tons=total_tons*proportion_of_tons,
    umbDisp="disposal"
  ) %>%
  select(-total_tons, -proportion_of_tons)

# now recombine the altered data with the static data
junk_dispose_all <-
  bind_rows(junk_dispose_static, junk_dispose_alter3) %>%
  group_by(year, wasteshed, material, umbDisp, disposition) %>%
  summarise(tons=sum(tons)) %>%
  ungroup() %>%
  mutate(scenario="dispose_all", optVariant="dispose_all")
# that's the dispose_all scenario

rm(disposal_disposition_proportions_by_wasteshed, junk_dispose_alter1,
   junk_dispose_alter2, junk_dispose_alter3, junk_dispose_static)
```

So the actual and the dispose_all mass profiles have been created.  Now, for the optimal.

This is a bit tricky, because of the transport distances. Here I need to set up some code that allows the entry (currently in code) of special transport distances.  See below!

```{r}
# file with all the combos of end-of-life-transport-dispositions and material
temp_mat_disp_combo <-
  impact_factors %>%
  filter(LCstage=="endOfLifeTransport") %>%
  select(material, disposition, LCstage, impliedMiles) %>%
  unique()
temp_wastesheds <-
  masses_eol %>% select(wasteshed) %>% unique()
temp_special_mileages <-
  full_join(
    temp_mat_disp_combo %>% mutate(dummy=1),
    temp_wastesheds %>% mutate(dummy=1),
    by="dummy"
  ) %>%
  select(-dummy) %>%
  rename(miles=impliedMiles) %>%
  mutate(
    # here is where any manual changes to miles could go
    # (ultimately i guess this needs to be a lookup table of some kind)
    miles=miles
  )
# ok, now I need create an impact factor file for each wasteshed,
# with special mileages included
temp_ifs_by_ws <-
  full_join(
    impact_factors %>% mutate(dummy=1),
    temp_wastesheds %>% mutate(dummy=1),
    by="dummy"
  ) %>%
  select(-dummy)
# now we merge the mileage file
# to end up with the impact factors by wasteshed.
impact_factors_by_wasteshed <-
  left_join(
    temp_ifs_by_ws,
    temp_special_mileages,
    by=c("material", "disposition", "LCstage", "wasteshed")
  ) %>%
  # use any custom end-of-life transport mileages.
  mutate(
    miles=ifelse(
      is.na(miles),
      impliedMiles,
      miles
    )
  )
# now we need to find the optimal ones.
# first, summing up eol impact using the custom mileeage
optimal_eol_picks_by_wasteshed <-
  impact_factors_by_wasteshed %>% filter(LCstage != "production") %>%
  mutate(
    impact_score1 = case_when(
      LCstage=="endOfLifeTransport" ~ impactFactor*miles/impliedMiles,
      LCstage=="endOfLife" ~ impactFactor
    )
  ) %>%
  group_by(
    impactCategory,
    impactUnits,
    wasteshed,
    material,
    disposition
  ) %>%
  summarize(
    impact_score2 = sum(impact_score1)
  ) %>%
  mutate(
    lowest=min(impact_score2),
    optimalEOLchoice=ifelse(impact_score2==lowest,TRUE,FALSE)
  ) %>%
  select(-impact_score2, -lowest)

rm(temp_ifs_by_ws, temp_mat_disp_combo, temp_special_mileages, temp_wastesheds)
```

Ok, I've gotten that far.  I have the optimal picks for each wasteshed by impactCategory.

next: i need to apply them to all of the end-of-life tons.  and then label the scenario "optimal" and the optVariant as the impactCategory.
