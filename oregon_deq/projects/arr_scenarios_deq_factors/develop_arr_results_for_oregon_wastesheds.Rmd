---
title: "Creating Alternative Recovery Rate results for Oregon wastesheds"
output: html_notebook
---

by Martin Brown, Martin.Brown@state.or.us

The goal of this R markdown notebook is to generate the results used in ARR analyses, specifically for Oregon wastesheds.

Basically I need to take the existing solid waste data file and impact factors, and calculate weight and impact factors for each of them.  At first I will just do this for the current "baseline" data set, but then I will create variant data sets based on the ARR scenarios.

I will document this more later.

Important assumptions:

* the baseline mass profile contains the entire solid waste stream
* the impact factor file contains not just impact factors for all the dispositions in the mass profile, but all the dispositions we wish to consider.
* material and disposition names are perfectly matched between the mass profile and impact factor files
* the "umbDisp" (umbrella disposition) field is filled in and meaningful for each line of the entry.

Load in some packages I might use
```{r}
library(tidyverse)
library(scales)
library(knitr)
library(rmarkdown)
library(svglite)
library(ggthemes)
library(broom)
```
Run some code to set a graphic style.

```{r}
source("../../resources/theme_539.R")
```


Load in the baseline masses and the impact factors.
```{r}
baseline_mass_profile <-
  readRDS("intermediate_output/baseline_mass_profile.RData")
  
impact_factors <-
  readRDS("intermediate_output/impact_factors.RData")
```


## Weight and recovery rate chart

Need to generate a chart that shows just weight of materials in the wastestream, with their recovery rates.  This will be in the app too, so I will save the data files used for the chart.

```{r}
masses_eol <- baseline_mass_profile

masses_eol_by_umbDisp <-
  summarise(
    group_by(masses_eol, year, wasteshed, material, umbDisp),
    tons=sum(tons)
  ) %>%
  ungroup() %>%
  mutate(
    datatype="weight",
    recovered_tons = ifelse(umbDisp=="recovery",tons,0)
  )

saveRDS(
  masses_eol_by_umbDisp,
  "intermediate_output/masses_eol_by_umbDisp.RData"
)

masses_eol_with_rr <-
  summarise(
    group_by(masses_eol_by_umbDisp, year, wasteshed, material),
    tons = sum(tons),
    recovered_tons=sum(recovered_tons)
  ) %>%
  ungroup() %>%
  group_by(year, wasteshed) %>%
  mutate(
    wb_recovery_rate=recovered_tons/tons,
    pctOfTotal = tons/sum(tons)
    ) %>% 
  ungroup()

saveRDS(
  masses_eol_with_rr,
  "intermediate_output/masses_eol_with_rr.RData"
)

material_sort_order <-
  summarise(
    group_by(masses_eol_with_rr, material),
    tons=sum(tons)
  ) %>%
  ungroup() %>%
  arrange(tons) %>%
  pull(material)

saveRDS(
  material_sort_order,
  "intermediate_output/material_sort_order.RData"
)
```

This is enough to make the weight and recovery rate chart.  Let's do it and save the output.

```{r fig.height=4.5, fig.width=6}
ggplot()+
  ggtitle("Weights and recovery rates for materials in the waste stream")+
  theme_539()+
  geom_bar(
    data=masses_eol_by_umbDisp %>% filter(wasteshed=="Metro"),
    aes(
      x = factor(material, levels=material_sort_order), 
      y = tons, color=umbDisp, fill=umbDisp, alpha=umbDisp
    ),
    stat="identity"
  )+
  geom_text(
    data=masses_eol_with_rr %>% filter(wasteshed=="Metro"),
    aes(
      x=material, 
      y=tons,
      label=percent(round(wb_recovery_rate, 2))
    ),
    hjust=-0.1
  )+
  scale_y_continuous(name="short tons", labels=comma)+
  coord_flip()+
  scale_colour_manual(values=rev(c("aquamarine4","steelblue4")))+
  scale_fill_manual(values=rev(c("aquamarine4", "steelblue4")))+
  scale_alpha_manual(values=c(0.25,0.75))+
  theme(
    legend.position=c(0.7,0.2),
    axis.title=element_text(),
    axis.title.y=element_blank(),
    axis.title.x=element_text()
  )
ggsave(
  "chart_output/examples/weights_and_recovery_rates_for_a_wasteshed.svg",
  bg="transparent"
  )
ggsave(
  "chart_output/examples/weights_and_recovery_rates_for_a_wasteshed.png",
  bg="transparent"
)
```


Now I've got to get impact numbers.  This will be considerably longer as there are approximately half a dozen impact categories I am using.

The following impact calculation will (eventually) depend on end-of-life-transport mileages customized to each wasteshed.  For now I will just use the defaults.

```{r}
# before I can calculate life cycle impacts I need to add production tons.
masses_prod <-
  masses_eol_with_rr %>%
  select(year, wasteshed, material, tons) %>%
  mutate(disposition="production", umbDisp="production")
masses_lc <-
  bind_rows(
    masses_eol,
    masses_prod
  ) %>%
  arrange(year, wasteshed, material,  disposition)
masses_with_impacts_in_detail <-
  left_join(
    masses_lc,
    impact_factors,
    by=c("material", "disposition")
  ) %>%
  mutate(
    # if end-of-life-miles are missing, sets them to default
    miles=
      ifelse(
        is.na(miles) & disposition!="production",
        impliedMiles,
        miles
      ),
    # calculates impacts
    impact=
      ifelse(
        LCstage=="endOfLifeTransport",
        tons*impactFactor*(miles/impliedMiles),
        tons*impactFactor
      )
  ) %>%
  arrange(impactCategory, year, wasteshed, material, LCstage, disposition)

impacts_by_wasteshed_and_material <-
  summarise(
    group_by(
      masses_with_impacts_in_detail,
      impactCategory,
      impactUnits,
      year, wasteshed, material
    ),
    impact=sum(impact)
  ) %>%
  ungroup() %>%
  group_by(impactCategory, impactUnits, year, wasteshed) %>%
  mutate(pctOfTotal=impact/sum(impact)) %>%
  ungroup()
```


At this point I am almost ready to create the first two "potential of recovery" type charts, which are the wastestream waste chart, and the percent weight vs. percent impact chart.

So i need to make a file that has these values

impactCategory
impactUnits
year
wasteshed
material
datatype (weight or impact)
stat (pctTons, or pctOfImpact)

```{r}
junk1 <-
  masses_eol_with_rr %>%
  select(year, wasteshed, material, tons, pctOfTotal) %>%
  mutate(
    impactCategory="Weight", 
    impactUnits="short tons",
    datatype="weight"
    ) %>%
  rename(magnitude=tons)
junk2 <-
  impacts_by_wasteshed_and_material %>%
  mutate(datatype="impact") %>%
  rename(magnitude=impact)


weight_vs_impact_chart_data <-
  bind_rows(junk2, junk1) %>%
  mutate(
    datatype=factor(datatype, levels=c("weight","impact")),
    material=factor(material, levels=material_sort_order)
  )

saveRDS(
  weight_vs_impact_chart_data,
  "intermediate_output/weight_vs_impact_chart_data.RData"
)
write.csv(
  weight_vs_impact_chart_data,
  "intermediate_output/weight_vs_impact_chart_data.csv",
  row.names = F
)

```

So weight_vs_impact_chart_data should have what I need.

let's make the chart.

```{r fig.height=4.5, fig.width=6}
junk3 <-
  weight_vs_impact_chart_data %>%
  filter(
    (impactCategory=="Weight" | impactCategory=="Energy demand")
    & wasteshed=="Benton"
  ) 
ggplot()+
  theme_539()+
  geom_bar(
    data=junk3,
    aes(x=material, y=pctOfTotal, color=datatype, fill=datatype),
    alpha=0.5,
    stat="identity",
    position="stack"
  )+
  facet_grid(.~datatype)+
  coord_flip()+
  theme(legend.position="none")
  
```

let's clean up some of this workspace.

```{r}
rm(junk1, junk2, junk3)
```

## Interpreting the alternative recovery rate law

Now it's time to do the thing I've been dreading... figure out how to interpret the "Alternative Recovery Rate" law in terms of data processing.

To sum up, oregon law requires DEQ to calculate "recovery rates" based on the impacts associated with different conceptual ways of dealing with solid waste.  In the Waste Impact Calculator model, this is equivalent to taking observed solid waste and applying it to different end of life dispositions.  For each conceptual management scenario, a mass profile is created.  Each mass profile can be converted into a life cycle impact.  Comparing the impacts associated with the scenarios generates the alternative recovery rate.

To get more detailed than that, let's look at the [text of the Alternative Recovery Rate law](https://www.oregonlaws.org/ors/459A.012).

>ORS 459A.012 - Alternative recovery rate calculation methods

>(1)(a) The Environmental Quality Commission shall develop and adopt by rule a method for calculating recovery rates based on the rate of energy savings achieved by recovering materials from the general solid waste stream. The calculation method must account for:

>(A) The energy savings achieved from material recovery, as opposed to material disposal;

>(B) Recovery of energy from waste, including methane recovery at landfills; and

>(C) Energy saving practices implemented as part of local solid waste reduction, reuse and recycling programs or solid waste management programs, including but not limited to:

>(i) Fuel, efficiency and other improvements involving waste collection vehicles;

>(ii) Energy efficiency improvements at recycling and solid waste facilities; and

>(iii) Production of energy from renewable sources at solid waste facilities through means other than recovery of energy from waste, such as the use of solar energy to produce electricity.

>(b) A recovery rate of 100 percent under the calculation method is equivalent to the energy savings achieved if all materials in the general solid waste stream are directed to their optimal final destinations for purposes of the energy savings that can be achieved through the recovery of each type of material.

>(2) Using the calculation method developed under subsection (1) of this section, the commission shall adopt by rule recovery goals consistent with the goals under ORS 459A.010 (Policy) (1) and (2).

>(3)(a) The commission may develop and adopt by rule other methods for calculating recovery rates from the general solid waste stream that are based on achieving outcomes that result from waste recovery and management, and may include but are not limited to the following:

>(A) Reductions in greenhouse gas emissions.

>(B) Reductions in the emissions of toxic or potentially toxic chemicals.

>(C) Water conservation.

>(b) The commission may adopt by rule other outcome-based recovery goals consistent with the goals under ORS 459A.010 (Policy) (1) and (2) using outcome-based calculation methods developed under this subsection. [2015 c.534 §9]

That's the whole text.  Now let's parse it a bit.

>(1)(a) ...recovery rates based on the rate of energy savings achieved by recovering materials from the general solid waste stream. 

So it is about recovering materials from the general solid waste stream.   That's the data DEQ usually deals with, so no big change in focus there.  Important point: existing law already defines "recovery."  So we are not changing the definition of "recovery."

> The calculation method must account for:

>(A) The energy savings achieved from material recovery, as opposed to material disposal;

This part sets up the first contrast... the SAVINGS achieved via recovery IN CONTRAST to disposal.  Disposal is also defined in law.  So, savings= energy associated with disposal MINUS energy associated with recovery.

Savings are always a DIFFERENCE.  In this case the difference is between the energy impact of disposal and the energy impact of recovery.

This is the key thing.  SAVINGS ARE A DIFFERENCE.

>(B) Recovery of energy from waste, including methane recovery at landfills; and

This part insists that energy recovery, including methane recovery at landfills, be part of calculations.  This is already the case.  Peter Canepa's landfilling and incineration impact factors include energy recovered via combustion.  I should confirm this.

I do not take this line to mean that the state's definition of recovery is changing.  This section of law does not overrule the rest of the law, it merely provides an alternative statistic for progress.

>(C) Energy saving practices implemented as part of local solid waste reduction, reuse and recycling programs or solid waste management programs, including but not limited to:

>(i) Fuel, efficiency and other improvements involving waste collection vehicles;

>(ii) Energy efficiency improvements at recycling and solid waste facilities; and

>(iii) Production of energy from renewable sources at solid waste facilities through means other than recovery of energy from waste, such as the use of solar energy to produce electricity.

These clauses are problematic from a practical perspective.  The law is about differences in energy use between disposal and recovery.  If there are energy efficiency improvements within the infrastructure, they could affect disposal energy use, recovery energy use, or both.  So it's not clear where such improvements would be applied, or if they would influence the ultimate calculation of DIFFERENCE between disposal and recovery.

In addition, figuring out the energy impact characteristics of specific technological changes is a lot of work that requires a skilled analyst. Investigating every notion of this kind could easily overwhelm DEQ's office.  This seems like a bad use of ratepayer money when it is very likely such technological changes will have only small influence over the ultimate energy impact numbers.

Accordingly, I suggest that any corrections of this kind be supplied by the wastesheds themselves.  I will provide them with a format to use.  And they must submit a file in that format, with documentation of evidence behind their numbers.

>(b) A recovery rate of 100 percent under the calculation method is equivalent to the energy savings achieved if all materials in the general solid waste stream are directed to their optimal final destinations for purposes of the energy savings that can be achieved through the recovery of each type of material.

This is the other key section.  The energy use associated with recovery is to be calculated for the OPTIMAL scenario.  Where each individual material goes to its lowest-impact destination.

This is where the methodological stuff ends.  I am left with this interpretation...

* savings is a difference
* the maximum possible savings is energy use linked to DISPOSING EVERYTHING minus energy use linked to RECOVERING EVERYTHING OPTIMALLY. This difference defines the 100% recovery rate.
* the current savings is energy use linked to DISPOSING EVERYTHING minus the energy use linked to THE CURRENT MIX OF DISPOSAL AND RECOVERY.

Or, let's shorten the lingo and give these scenarios names.

* current savings = DISPOSE_ALL - ACTUAL
* max possible savings = DISPOSE_ALL - OPTIMAL
* alternative recovery rate = CURRENT_SAVINGS/MAX_POSSIBLE_SAVINGS

>(2) Using the calculation method developed under subsection (1) of this section, the commission shall adopt by rule recovery goals consistent with the goals under ORS 459A.010 (Policy) (1) and (2).

This section just says there will be written goals based on these numbers.

>(3)(a) The commission may develop and adopt by rule other methods for calculating recovery rates from the general solid waste stream that are based on achieving outcomes that result from waste recovery and management, and may include but are not limited to the following:

>(A) Reductions in greenhouse gas emissions.

>(B) Reductions in the emissions of toxic or potentially toxic chemicals.

>(C) Water conservation.

>(b) The commission may adopt by rule other outcome-based recovery goals consistent with the goals under ORS 459A.010 (Policy) (1) and (2) using outcome-based calculation methods developed under this subsection. [2015 c.534 §9]

These sections just say that the same logic can be applied to other impact categories.  

So whatever computing logic I come up with, it has to work for all the impact categories, not just energy use.  That's no big deal.

### The way to do this.

The ACTUAL scenario is easy.  Just take the current materials, dispositions, and end-of-life mileages and calculate the impacts for them.  All I really need to do here is to add a "scenario" label to the existing mass profile.

The DISPOSE_ALL scenario is a little trickier.  All of the currently disposed stuff will go to the same dispositions.  But all of the currently recovered stuff will go to disposal dispositions.  Simplest would just be to landfill it I suppose.  But more accurate might be to use the same mix of disposal dispositions (landfilling vs. incineration) as are currently used.  A bit of a pain but doable.

The OPTIMAL scenario is the most labor.  So, for each wasteshed and material, there are a number of plausible recovery dispositions.  The aggregate impact factors for each (a combination of end-of-life impact factor and end-of-life-transport factor for the custom distance) must be calculated and then sorted.  The disposition with the lowest impact factor is the one that will then be applied to ALL of that wasteshed's material.  

These dispositions may actually be different for different impact categories... meaning there are actually numerous different versions of the OPTIMAL scenario, depending on which impact category you are interested in.

To deal with this hassle, you might choose one impact category.  Or you might average them.  Or I guess you could add an additional indexing variable to keep them all separate... but that would make display in the shiny app weird.  You would display only the optimal mass profile associated with the currently selected impact category.

I guess this indexing variable would have the same range of values as "impactCategory".

Ok, I have a direction.  Next step is just to do it.  Just do it systematically.  Build in checks.

```{r}
# labelling the actual scenario
junk_actual <-
  masses_lc %>% mutate(scenario="actual", optVariant="actual")

# working up the dispose all scenario
# first, stuff that will stay the same
junk_dispose_static <-
  masses_lc %>% 
  filter(umbDisp=="production" | umbDisp=="disposal")
# next, stuff that will change
junk_dispose_alter1 <-
  masses_lc %>% filter(umbDisp=="recovery")
# summarizing the alterable tons
junk_dispose_alter2 <-
  summarise(
    group_by(
      junk_dispose_alter1,
      year, wasteshed, material
    ),
    tons=sum(tons)
  )
# now multiplying that across the observed disposal fractions for that wasteshed.
# the disposal fraction data
disposal_disposition_proportions_by_wasteshed <-
  readRDS(
    "intermediate_output/disposal_disposition_proportions_by_wasteshed.RData"
  )
junk_dispose_alter3 <-
  left_join(
    junk_dispose_alter2,
    disposal_disposition_proportions_by_wasteshed,
    by = c("year", "wasteshed")
  ) %>%
  rename(total_tons=tons) %>%
  mutate(
    tons=total_tons*proportion_of_tons,
    umbDisp="disposal",
    # CERTAIN NONORGANIC MATERIALS ARE NONSENSICAL FOR
    # COMBUSTION.  I NEED TO FIND A MORE SYSTEMATIC WAY
    # OF DEALING WITH THIS, BUT FOR NOW THERE IS JUST A 
    # MANUAL FIX.  
    disposition=case_when(
      material=="Aluminum" ~ "landfilling",
      material=="Glass" ~ "landfilling",
      material=="ScrapMetal" ~ "landfilling",
      material=="TinnedCan" ~ "landfilling",
      TRUE ~ disposition
    )
  ) %>%
  select(-total_tons, -proportion_of_tons)

# now recombine the altered data with the static data
junk_dispose_all <-
  bind_rows(junk_dispose_static, junk_dispose_alter3) %>%
  group_by(year, wasteshed, material, umbDisp, disposition) %>%
  summarise(tons=sum(tons)) %>%
  ungroup() %>%
  mutate(scenario="dispose_all", optVariant="dispose_all") %>%
  # fixing a nonsensical entry ... must find the source eventually
  mutate(
    disposition = ifelse(
      material=="Electronics" & disposition=="combustion",
      "landfilling",
      disposition
    )
  )
# that's the dispose_all scenario

rm(disposal_disposition_proportions_by_wasteshed, junk_dispose_alter1,
   junk_dispose_alter2, junk_dispose_alter3, junk_dispose_static)
```

So the actual and the dispose_all mass profiles have been created.  Now, for the optimal.

This is a bit tricky, because of the transport distances. Here I need to set up some code that allows the entry (currently in code) of special transport distances.  See below!

```{r}
# file with all the combos of end-of-life-transport-dispositions and material
temp_mat_disp_combo <-
  impact_factors %>%
  filter(LCstage=="endOfLifeTransport") %>%
  select(material, disposition, LCstage, impliedMiles) %>%
  unique()
temp_wastesheds <-
  masses_eol %>% select(wasteshed) %>% unique()
# temp_special_mileages <-
#   full_join(
#     temp_mat_disp_combo %>% mutate(dummy=1),
#     temp_wastesheds %>% mutate(dummy=1),
#     by="dummy"
#   ) %>%
#   select(-dummy) %>%
#   rename(miles=impliedMiles) %>%
#   mutate(
#     # here is where any manual changes to miles could go
#     # (ultimately i guess this needs to be a lookup table of some kind)
#     miles=miles
#   )
temp_special_mileages <-
  masses_lc %>% 
  filter(disposition!="production") %>%
  select(wasteshed, material, disposition, miles) %>%
  unique() %>%
  mutate(LCstage="endOfLifeTransport")

# ok, now I need create an impact factor file for each wasteshed,
# with special mileages included
temp_ifs_by_ws <-
  full_join(
    impact_factors %>% mutate(dummy=1),
    temp_wastesheds %>% mutate(dummy=1),
    by="dummy"
  ) %>%
  select(-dummy)
# now we merge the mileage file
# to end up with the impact factors by wasteshed.
impact_factors_by_wasteshed <-
  left_join(
    temp_ifs_by_ws,
    temp_special_mileages,
    by=c("material", "disposition", "LCstage", "wasteshed")
  ) %>%
  # use any custom end-of-life transport mileages.
  mutate(
    miles=ifelse(
      is.na(miles),
      impliedMiles,
      miles
    )
  )
# now we need to find the optimal ones.
# first, summing up eol impact using the custom mileeage
optimal_eol_picks_by_wasteshed <-
  impact_factors_by_wasteshed %>% filter(LCstage != "production") %>%
  mutate(
    impact_score1 = case_when(
      LCstage=="endOfLifeTransport" ~ impactFactor*miles/impliedMiles,
      LCstage=="endOfLife" ~ impactFactor
    )
  ) %>%
  group_by(
    impactCategory,
    impactUnits,
    wasteshed,
    material,
    disposition
  ) %>%
  summarize(
    impact_score2 = sum(impact_score1)
  ) %>%
  mutate(
    lowest=min(impact_score2),
    optimalEOLchoice=ifelse(impact_score2==lowest,TRUE,FALSE)
  ) %>%
  select(-impact_score2, -lowest)

rm(temp_ifs_by_ws, temp_mat_disp_combo, temp_special_mileages, temp_wastesheds)
```

Ok, I've gotten that far.  I have the optimal picks for each wasteshed by impactCategory.

next: i need to apply them to all of the end-of-life tons.  and then label the scenario "optimal" and the optVariant as the impactCategory.

So I get masses at the end of life, and total them for each year, wasteshed, and material.  At this point disposition has disappeared.  Then I apply the optimal dispositions to them.  There should only be 1 for each combo, so that shouldn't change the number of lines (except that the lines should be multiplied by 6, for each of the impact categories.)  Then i need to add production tons for each... i guess i could just duplicate the existing file and change disposition to production.

```{r}
junk_masses_eol_sum <-
  summarise(
    group_by(masses_eol, year, wasteshed, material),
    tons=sum(tons)
  ) %>%
  ungroup()

junk_masses_eol_with_optimal <-
  left_join(
    junk_masses_eol_sum,
    filter(optimal_eol_picks_by_wasteshed, optimalEOLchoice==TRUE),
    by = c("wasteshed", "material")
  ) %>%
  arrange(impactCategory, wasteshed, material, disposition) %>%
  select(-optimalEOLchoice) %>%
  mutate(scenario="optimal", optVariant=impactCategory)

# now to get production tons I just double that
junk_masses_prod_from_optimal <-
  junk_masses_eol_with_optimal %>%
  mutate(disposition="production")

# all tons for the optimal scenario 
junk_optimal <-
  bind_rows(
    junk_masses_prod_from_optimal,
    junk_masses_eol_with_optimal
  ) %>%
  arrange(
    impactCategory,
    year, wasteshed, material, disposition
  ) %>%
  select(-impactCategory, -impactUnits)

# need to save the list of optVariants for later
junk_list_of_optVariants <-
  junk_masses_eol_with_optimal %>%
  select(scenario, optVariant) %>%
  unique()
```

gotta make a zero file of all the possibilities for each optvariant
```{r}
junk_optimal_zero <-
  full_join(
    masses_lc %>% mutate(dummy=1),
    junk_list_of_optVariants %>% mutate(dummy=1),
    by="dummy"
  ) %>%
  select(-dummy) %>%
  rename(otons=tons) %>% 
  arrange(scenario, optVariant, year, wasteshed, material, disposition)
```

```{r}
# now merging the optimal masses with all the possibles
# (which fills in zeros and gives us umbrella dispositions)
junk_optimal_plus <-
  full_join(
    junk_optimal_zero, 
    junk_optimal,
    by=c("scenario", "optVariant", 
         "year", "wasteshed", "material", "disposition")
  ) %>%
  mutate(tons=ifelse(is.na(tons),0,tons)) %>%
  arrange(optVariant, year, wasteshed, material, disposition)
```

So, junk_optimal_plus is almost right.  But occasionally it gets thrown off if there is >1 umbrella disposition associated with the optimal disposition.  So I need to correct for that.

```{r}
junk_optimal_count <-
  junk_optimal_plus %>%
  group_by(
    scenario, optVariant, year, wasteshed, material, disposition
  ) %>%
  summarise(myCount=n()) %>%
  ungroup()

junk_optimal_plus_2 <-
  left_join(
    junk_optimal_plus,
    junk_optimal_count,
    by = c("scenario", "optVariant", "year", "wasteshed",
           "material", "disposition")
  ) %>%
  mutate(
    tons=ifelse(disposition!="production",tons/myCount,tons)
  ) %>%
  select(-myCount, -otons)
```

Ok, that seems to add up. 

I will put more checks in later.

Next step (after a break)... get all those scenarios into symmetrical files, merge them, and get rid of temporary objects.

```{r}
# building the summary file...
# the first scenario, ACTUAL, is done.  results are in junk_actual.
# the second scenario, DISPOSE_ALL, is also done, but missing some
# zeros.  so let's create one with all the zeros.
junk_dispose_all_better <-
  full_join(
    junk_actual %>% select(-tons, -scenario, -optVariant),
    junk_dispose_all,
    by = c("year", "wasteshed", "material", "disposition", "umbDisp")
  ) %>%
  mutate(
    tons = ifelse(is.na(tons),0,tons),
    scenario="dispose_all",
    optVariant="dispose_all"
  )
# the third scenario, OPTIMAL, is in junk_optimal_plus_2
# let's merge and save them
arr_mass_profiles <-
  bind_rows(
    junk_actual,
    junk_dispose_all_better,
    junk_optimal_plus_2
  ) %>%
  arrange(scenario, optVariant, year, wasteshed, material,
          disposition)
```


cleaning up the workspace

```{r}
# removing all but the needed objects
rm(
  list=
    setdiff(
      ls(), 
      c("arr_mass_profiles", 
        "impact_factors_by_wasteshed",
        "impact_factors", 
        "deq_pal",
        "material_sort_order", 
        "theme_539"
      )
    )
)
```


I should have what I need... a single file with all the masses for all the scenarios (arr_mass_profiles)

Let's just double check that there are impact factors for all of them.
```{r}
testSet1 <-
  left_join(
    arr_mass_profiles,
    impact_factors,
    by = c("material", "disposition")
  ) 
testSet2 <-
  testSet1 %>% filter(is.na(impactFactor))
print(testSet2)
testSet3 <-
  arr_mass_profiles %>%
  group_by(scenario, optVariant) %>%
  summarise(tons=sum(tons)) %>%
  ungroup()
print(testSet3)
```


testSet2 should have no missing impact factors
testSet3 should have the same number of tons in each scenario and variant.

```{r}
# cleaning up the test objects
rm(testSet1, testSet2, testSet3)
```

## Generating the ARR charts

So now I want to make charts expressing the ARR.

on one side is a stacked bar chart of the weights in 3 scenarios.
dispose_all, actual, and one of the optimals.

on the other side a stacked bar chart of the life cycle impacts.

```{r}
impacts_in_detail <-
  left_join(
    arr_mass_profiles,
    impact_factors_by_wasteshed %>% select(-miles),
    by=c("wasteshed", "material", "disposition")
  ) %>%
  arrange(
    optVariant,
    impactCategory,
    wasteshed,
    material,
    LCstage,
    disposition
  ) %>%
  mutate(
    impact=
      ifelse(
        LCstage=="endOfLifeTransport",
        tons*impactFactor*miles/impliedMiles,
        tons*impactFactor
      )
  )
impacts_arr_selected_source_data <-
  impacts_in_detail %>%
  filter(
#    (material=="Aluminum" | material=="Cardboard") & 
    # (wasteshed=="Baker" | wasteshed=="Benton") &
    # (impactCategory=="Smog" | impactCategory=="Global warming") &
    # optVariant %in%
    #   c("Smog", "Global warming", "actual", "optimal", "dispose_all")
  ) %>%
  filter(
    scenario == "actual" | scenario=="dispose_all" |
      scenario == "optimal" & impactCategory==optVariant
  )
impacts_arr_sums_for_chart <-
  summarise(
    group_by(
      impacts_arr_selected_source_data,
      wasteshed, impactCategory, impactUnits, optVariant, scenario
    ),
    impact=sum(impact)
  ) %>%
  ungroup()
impacts_arr_sums_wider <-
  pivot_wider(
    impacts_arr_sums_for_chart %>% select(-optVariant),
    names_from = "scenario",
    values_from = "impact"
  ) %>%
  mutate(
    arr=(dispose_all-actual)/(dispose_all-optimal)
  )
```

ok so that file (impacts_arr_sums_for_chart) has impact sums, but not weight based stuff.  i've gotta go back and get the weight-based recovery rate for each scenario.

```{r}
weight_stuff_for_chart_1 <-
  impacts_arr_selected_source_data %>%
  filter(LCstage=="endOfLife") %>%
  select(year, wasteshed, material, disposition, tons, 
         umbDisp, scenario, optVariant) %>%
  unique()

weight_stuff_for_chart_2 <-
  weight_stuff_for_chart_1 %>%
  mutate(recoveredTons=ifelse(umbDisp=="recovery",tons,0)) %>%
  group_by(
    optVariant,
    wasteshed,
    scenario,
    umbDisp
  ) %>%
  summarise(
    tons=sum(tons),
    recoveredTons=sum(recoveredTons)
    ) %>%
  ungroup() %>%
  arrange(wasteshed, optVariant, scenario, umbDisp)

weight_stuff_for_chart_3 <-
  weight_stuff_for_chart_2 %>%
  group_by(wasteshed, optVariant, scenario) %>%
  summarise(
    tons=sum(tons),
    recoveredTons=sum(recoveredTons),
    rr=sum(recoveredTons)/sum(tons)
  ) %>%
  ungroup()
```

not sure if that was the most efficient way to do it, but there's the data i need.

```{r}
# for making a model of impact x recovery rate i can combine the weight and
# impact files.

arr_model_maker <-
  full_join(
    impacts_arr_sums_for_chart,
    weight_stuff_for_chart_3 %>% select(-tons, -recoveredTons),
    by=c("wasteshed", "optVariant", "scenario")
  ) %>%
  mutate(
    scenario=factor(scenario, levels=c("dispose_all", "actual", "optimal"))
  ) %>%
  group_by(wasteshed, impactCategory, impactUnits)
arr_model <-
  do(
    arr_model_maker,
    tidy(
      lm(
        impact~rr,
        data=.,
        singular.ok = TRUE
      )
    )
  )
arr_model_coeff <-
  pivot_wider(
    arr_model %>% select(wasteshed, impactCategory, impactUnits, term, estimate),
    names_from="term",
    values_from = "estimate"
  ) %>%
  rename(rr_intercept=`(Intercept)`, rr_slope=rr)
```

now making a plot
```{r}
#ggplot()+
#  ggtitle("test ARR impact plot")+
  # theme_539()+
  # geom_bar(
#     data=arr_model_maker,
#     aes(x=scenario, y=impact),
#     stat="identity"
#   )+
#   facet_wrap(wasteshed~impactCategory, scales="free")
# ggplot()+
#   ggtitle("test ARR trend plot")+
#   theme_539()+
#   geom_point(
#     data=arr_model_maker,
#     aes(x=rr, y=impact,  fill=scenario, color=scenario)
#   )+
#   geom_abline(
#     data=arr_model_coeff,
#     aes(intercept=rr_intercept, slope=rr_slope)
#   )+
#  facet_wrap(wasteshed~impactCategory, scales="free")
```

I haven't checked any of the numbers, but I am going to move on to writing some of the output data files for use in the app.

```{r}
# need one file with one record per wasteshed and optVariant
arr_summary_data_0 <-
  full_join(
    impacts_arr_sums_wider,
    arr_model_coeff,
    by=c("wasteshed", "impactCategory", "impactUnits")
  )
arr_summary_data_1 <-
  full_join(
    arr_summary_data_0,
    weight_stuff_for_chart_3 %>% 
      filter(scenario=="actual") %>%
      select(wasteshed, rr) %>%
      rename(wb_rr=rr),
    by="wasteshed"
  ) %>%
  mutate(curr_impact_reduction=1-(actual/dispose_all))
saveRDS(
  arr_summary_data_1,
  "intermediate_output/arr_summary_data_1.RData"
)
# also need one file with 2 records per wasteshed and optVariant
arr_summary_data_2 <-
  weight_stuff_for_chart_2 %>% 
  select(-recoveredTons) %>%
  mutate(
    umbDisp=factor(umbDisp, levels=rev(c("disposal", "recovery"))),
    scenario=
      factor(
        scenario, 
        levels=rev(c("dispose_all", "actual", "optimal"))
      )
  )
saveRDS(
  arr_summary_data_2,
  "intermediate_output/arr_summary_data_2.RData"
)
# also need one file with 3 impact records per wasteshed and optVariant
arr_summary_data_3 <-
  impacts_arr_sums_for_chart %>%
  mutate(
    scenario=
      factor(
        scenario, 
        levels=rev(c("dispose_all", "actual", "optimal"))
      )
  )
saveRDS(
  arr_summary_data_3,
  "intermediate_output/arr_summary_data_3.RData"
)
```

Ok, i seem to have this working!
Now the thing is, to make the presentation in the app as clear as possible.

Maybe extremely simple charts... like a single bar chart to express amounts recovered and disposed... paired with a single bar chart to express life cycle impacts and impacts reduced.

Maybe then I could make a "scenario" bar where the user attempts to change impacts by reducing or recovering.

## Chart to express where impacts come from under all three scenarios

Prefix: wicf

So on left side of screen I would have weights for the wasteshed, material, and scenario.

On the right side of the screen I would have impacts by for the wasteshed, material, and scenario BY LC STAGE.


```{r}
wicf_impacts_by_lcstage <-
  summarise(
    group_by(
      impacts_arr_selected_source_data,
      wasteshed, impactCategory, impactUnits, optVariant, scenario,
      material, LCstage
    ),
    impact=sum(impact)
  ) %>%
  ungroup()

wicf_impacts_net <-
  summarise(
    group_by(
      wicf_impacts_by_lcstage,
      wasteshed, impactCategory, impactUnits, optVariant, scenario,
      material
    ),
    impact=sum(impact)
  ) %>%
  ungroup()

wicf_weights <-
  impacts_arr_selected_source_data %>%
  filter(LCstage=="endOfLife") %>%
  select(year, wasteshed, material, disposition, tons, 
         umbDisp, scenario, optVariant) %>%
  unique() %>%
  mutate(
    material=factor(material, levels=material_sort_order),
    umbDisp=factor(umbDisp, levels=c("disposal", "recovery"))
  )

wicf_weight_summaries <-
  wicf_weights %>%
  mutate(recoveredTons=ifelse(umbDisp=="recovery", tons,0)) %>%
  group_by(year, wasteshed, material, scenario, optVariant) %>%
  summarise(
    tons=sum(tons),
    recoveredTons=sum(recoveredTons)
  ) %>%
  ungroup() %>%
  mutate(wbrr=recoveredTons/tons)

# output these for use in the app and/or elsewhere
saveRDS(
  wicf_weight_summaries,
  "intermediate_output/wicf_weight_summaries.RData"
)

saveRDS(
  wicf_weights,
  "intermediate_output/wicf_weights.RData"
)
saveRDS(
  wicf_impacts_net,
  "intermediate_output/wicf_impacts_net.RData"
)
saveRDS(
  wicf_impacts_by_lcstage,
  "intermediate_output/wicf_impacts_by_lcstage.RData"
)
```

now making a sample chart to see if this works.

```{r fig.width=6, fig.height=4.5}
# sample weight chart
ggplot()+
#  theme_539()+
  ggtitle("Weight chart")+
  geom_bar(
    data=
      wicf_weights %>%
      filter(wasteshed=="Metro", scenario=="actual", 
             optVariant=="actual"),
    aes(
      x=material,
      y=tons,
      color=umbDisp,
      fill=umbDisp,
      alpha=umbDisp
    ),
    stat="identity",
    position="stack"
  ) +
  coord_flip()
```

Now making an impact chart in the same order.

```{r fig.width=6, fig.height=4}
ggplot()+
  theme_539()+
  ggtitle("impact chart")+
  geom_bar(
    data=
      wicf_impacts_by_lcstage %>%
      filter(wasteshed=="Metro" & scenario=="actual"
             & optVariant=="actual" & impactCategory=="Smog"),
    aes(
      x=factor(material, levels=material_sort_order),
      y=impact,
      color=LCstage,
      fill=LCstage
    ),
    stat="identity",
    position="stack",
    alpha=0.3
  )+
  geom_bar(
    data=
      wicf_impacts_net %>%
      filter(wasteshed=="Metro" & scenario=="actual"
             & optVariant=="actual" & impactCategory=="Smog"),
    aes(
      x=material,
      y=impact
    ),
    color="black",
    fill=NA,
    size=2,
    stat="identity"
  )+
  coord_flip()
```
